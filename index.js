const express = require('express');
const line = require('@line/bot-sdk');
const axios = require('axios');
const cron = require('node-cron');
const path = require('path');
const fs = require('fs');

const app = express();

// ÈùúÊÖãÊñá‰ª∂ÊúçÂãô
app.use(express.static('public'));

// LINE BotË®≠ÂÆö
const config = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET,
};

// Á©∫Ê∞£ÂìÅË≥™APIË®≠ÂÆö
const WAQI_TOKEN = 'b144682944ddd13da46203e66fed4fd6be745619';
const WAQI_BASE_URL = 'https://api.waqi.info';

// ÂâµÂª∫LINE BotÂÆ¢Êà∂Á´Ø
const client = new line.Client(config);

// Ë®ÇÈñ±ÁÆ°ÁêÜÔºàÂú®ÂØ¶ÈöõÈÉ®ÁΩ≤‰∏≠Âª∫Ë≠∞‰ΩøÁî®Ë≥áÊñôÂ∫´Ôºâ
let subscriptions = new Map(); // userId -> {cities: [], settings: {}}
let locationCache = new Map(); // userId -> {lat, lng, timestamp}

// ÂüéÂ∏ÇÂ∞çÊáâË°®
const cityMap = {
  'Âè∞Âåó': 'taipei',
  'Âè∞‰∏≠': 'taichung',
  'Âè∞Âçó': 'tainan',
  'È´òÈõÑ': 'kaohsiung',
  'Êñ∞Âåó': 'new-taipei',
  'Ê°ÉÂúí': 'taoyuan',
  'Âü∫ÈöÜ': 'keelung',
  'Êñ∞Á´π': 'hsinchu',
  'ËãóÊ†ó': 'miaoli',
  'ÂΩ∞Âåñ': 'changhua',
  'ÂçóÊäï': 'nantou',
  'Èõ≤Êûó': 'yunlin',
  'ÂòâÁæ©': 'chiayi',
  'Â±èÊù±': 'pingtung',
  'ÂÆúËò≠': 'yilan',
  'Ëä±ËìÆ': 'hualien',
  'Âè∞Êù±': 'taitung',
  'ÊæéÊπñ': 'penghu',
  'ÈáëÈñÄ': 'kinmen',
  'È¶¨Á•ñ': 'matsu',
  'Âåó‰∫¨': 'beijing',
  '‰∏äÊµ∑': 'shanghai',
  'Êù±‰∫¨': 'tokyo',
  'È¶ñÁàæ': 'seoul',
  'ÊõºË∞∑': 'bangkok',
  'Êñ∞Âä†Âù°': 'singapore',
  'È¶ôÊ∏Ø': 'hong-kong',
  'Êæ≥ÈñÄ': 'macau'
};

// Ë®àÁÆóÂÖ©ÈªûÈñìË∑ùÈõ¢ÔºàÂÖ¨ÈáåÔºâ
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Âú∞ÁêÉÂçäÂæëÔºàÂÖ¨ÈáåÔºâ
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Ê†πÊìö‰ΩçÁΩÆÊü•ÊâæÈôÑËøëÁöÑÁõ£Ê∏¨Á´ô
async function findNearbyStations(lat, lng) {
  try {
    const url = `${WAQI_BASE_URL}/search/?token=${WAQI_TOKEN}&keyword=geo:${lat};${lng}`;
    const response = await axios.get(url);
    
    if (response.data.status === 'ok' && response.data.data.length > 0) {
      // Ë®àÁÆóË∑ùÈõ¢‰∏¶ÊéíÂ∫è
      const stationsWithDistance = response.data.data
        .filter(station => station.geo && station.geo.length === 2)
        .map(station => ({
          ...station,
          distance: calculateDistance(lat, lng, station.geo[0], station.geo[1])
        }))
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 3); // ÂèñÂâç3ÂÄãÊúÄËøëÁöÑÁ´ôÈªû
      
      return stationsWithDistance;
    }
    return [];
  } catch (error) {
    console.error('Êü•ÊâæÈôÑËøëÁõ£Ê∏¨Á´ôÈåØË™§:', error);
    return [];
  }
}

// Ë®ÇÈñ±ÁÆ°ÁêÜÂäüËÉΩ
function addSubscription(userId, city) {
  if (!subscriptions.has(userId)) {
    subscriptions.set(userId, {
      cities: [],
      settings: {
        dailyReport: true,
        emergencyAlert: true,
        threshold: 100
      }
    });
  }
  
  const userSub = subscriptions.get(userId);
  if (!userSub.cities.includes(city)) {
    userSub.cities.push(city);
    return true;
  }
  return false;
}

function removeSubscription(userId, city) {
  if (subscriptions.has(userId)) {
    const userSub = subscriptions.get(userId);
    const index = userSub.cities.indexOf(city);
    if (index > -1) {
      userSub.cities.splice(index, 1);
      return true;
    }
  }
  return false;
}

function getUserSubscriptions(userId) {
  return subscriptions.get(userId) || { cities: [], settings: {} };
}

// ÂâµÂª∫ÈôÑËøëÁõ£Ê∏¨Á´ôFlex Message
function createNearbyStationsFlexMessage(stations, userLat, userLng) {
  if (stations.length === 0) {
    return {
      type: 'text',
      text: 'üòî Êä±Ê≠âÔºåÊâæ‰∏çÂà∞ÊÇ®ÈôÑËøëÁöÑÁ©∫Ê∞£ÂìÅË≥™Áõ£Ê∏¨Á´ô„ÄÇ\nË´ãÂòóË©¶Êü•Ë©¢ÁâπÂÆöÂüéÂ∏ÇÁöÑÁ©∫Ê∞£ÂìÅË≥™„ÄÇ'
    };
  }

  const flexMessage = {
    type: 'flex',
    altText: `ÈôÑËøëÁõ£Ê∏¨Á´ô - ÊâæÂà∞ ${stations.length} ÂÄãÁ´ôÈªû`,
    contents: {
      type: 'bubble',
      styles: {
        header: {
          backgroundColor: '#4CAF50'
        }
      },
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: 'üìç ÈôÑËøëÁ©∫Ê∞£ÂìÅË≥™Áõ£Ê∏¨Á´ô',
            weight: 'bold',
            color: '#ffffff',
            size: 'lg',
            align: 'center'
          }
        ]
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: []
      }
    }
  };

  stations.forEach((station, index) => {
    const aqiInfo = getAQILevel(station.aqi || 0);
    const distanceText = station.distance < 1 ? 
      `${Math.round(station.distance * 1000)}ÂÖ¨Â∞∫` : 
      `${station.distance.toFixed(1)}ÂÖ¨Èáå`;

    flexMessage.contents.body.contents.push(
      {
        type: 'box',
        layout: 'horizontal',
        spacing: 'sm',
        margin: index > 0 ? 'md' : 'none',
        contents: [
          {
            type: 'text',
            text: `${index + 1}`,
            size: 'lg',
            weight: 'bold',
            flex: 1,
            color: '#666666',
            align: 'center'
          },
          {
            type: 'box',
            layout: 'vertical',
            flex: 4,
            contents: [
              {
                type: 'text',
                text: station.station?.name || 'Êú™Áü•Á´ôÈªû',
                weight: 'bold',
                size: 'md',
                color: '#333333',
                wrap: true
              },
              {
                type: 'text',
                text: `Ë∑ùÈõ¢: ${distanceText}`,
                size: 'xs',
                color: '#999999'
              }
            ]
          },
          {
            type: 'box',
            layout: 'vertical',
            flex: 3,
            contents: [
              {
                type: 'text',
                text: `AQI ${station.aqi || 'N/A'}`,
                weight: 'bold',
                size: 'md',
                color: aqiInfo.color,
                align: 'end'
              },
              {
                type: 'text',
                text: aqiInfo.level,
                size: 'xs',
                color: '#666666',
                align: 'end'
              }
            ]
          }
        ]
      }
    );

    if (index < stations.length - 1) {
      flexMessage.contents.body.contents.push({
        type: 'separator',
        margin: 'md'
      });
    }
  });

  return flexMessage;
}

// ÊØèÊó•ÂÆöÊôÇÊé®ÈÄÅÁ©∫Ê∞£ÂìÅË≥™Â†±ÂëäÔºàÊØèÂ§©Êó©‰∏ä8ÈªûÔºâ
cron.schedule('0 8 * * *', async () => {
  console.log('ÈñãÂßãÁôºÈÄÅÊØèÊó•Á©∫Ê∞£ÂìÅË≥™Â†±Âëä...');
  
  for (const [userId, subscription] of subscriptions.entries()) {
    if (subscription.settings.dailyReport && subscription.cities.length > 0) {
      try {
        // ÁÇ∫Áî®Êà∂Ë®ÇÈñ±ÁöÑÂüéÂ∏ÇÂâµÂª∫Â†±Âëä
        const cityData = await getMultipleCitiesAirQuality(
          subscription.cities.map(city => ({ chinese: city, english: city }))
        );
        
        if (cityData.length > 0) {
          const dailyReportMessage = createDailyReportFlexMessage(cityData);
          await client.pushMessage(userId, dailyReportMessage);
        }
      } catch (error) {
        console.error(`ÁôºÈÄÅÊØèÊó•Â†±ÂëäÁµ¶Áî®Êà∂ ${userId} Â§±Êïó:`, error);
      }
    }
  }
}, {
  timezone: "Asia/Taipei"
});

// Ê™¢Êü•Á∑äÊÄ•Ë≠¶Â†±ÔºàÊØèÂ∞èÊôÇÊ™¢Êü•‰∏ÄÊ¨°Ôºâ
cron.schedule('0 * * * *', async () => {
  for (const [userId, subscription] of subscriptions.entries()) {
    if (subscription.settings.emergencyAlert && subscription.cities.length > 0) {
      try {
        for (const city of subscription.cities) {
          const airQualityData = await getAirQuality(city);
          
          // Â¶ÇÊûúAQIË∂ÖÈÅéÁî®Êà∂Ë®≠ÂÆöÁöÑÈñæÂÄºÔºåÁôºÈÄÅË≠¶Â†±
          if (airQualityData.aqi > subscription.settings.threshold) {
            const alertMessage = createEmergencyAlertMessage(airQualityData);
            await client.pushMessage(userId, alertMessage);
          }
        }
      } catch (error) {
        console.error(`Ê™¢Êü•Á∑äÊÄ•Ë≠¶Â†±Áµ¶Áî®Êà∂ ${userId} Â§±Êïó:`, error);
      }
    }
  }
}, {
  timezone: "Asia/Taipei"
});

// AQIÁ≠âÁ¥öÂà§Êñ∑
function getAQILevel(aqi) {
  if (aqi <= 50) return { level: 'ËâØÂ•Ω', color: '#00e400', emoji: 'üòä' };
  if (aqi <= 100) return { level: 'ÊôÆÈÄö', color: '#ffff00', emoji: 'üòê' };
  if (aqi <= 150) return { level: 'Â∞çÊïèÊÑüÊóèÁæ§‰∏çÂÅ•Â∫∑', color: '#ff7e00', emoji: 'üò∑' };
  if (aqi <= 200) return { level: '‰∏çÂÅ•Â∫∑', color: '#ff0000', emoji: 'üò∞' };
  if (aqi <= 300) return { level: 'ÈùûÂ∏∏‰∏çÂÅ•Â∫∑', color: '#8f3f97', emoji: 'ü§¢' };
  return { level: 'Âç±Èö™', color: '#7e0023', emoji: '‚ò†Ô∏è' };
}

// ÂÅ•Â∫∑Âª∫Ë≠∞Á≥ªÁµ±
function getHealthAdvice(aqi) {
  if (aqi <= 50) {
    return {
      general: 'Á©∫Ê∞£ÂìÅË≥™Ê•µ‰Ω≥ÔºÅÈÅ©ÂêàÊâÄÊúâÊà∂Â§ñÊ¥ªÂãï',
      sensitive: 'ÊïèÊÑüÊóèÁæ§‰πüÂèØÊ≠£Â∏∏Êà∂Â§ñÊ¥ªÂãï',
      exercise: 'üèÉ‚Äç‚ôÇÔ∏è Ê•µÈÅ©ÂêàÔºöË∑ëÊ≠•„ÄÅÈ®éËªä„ÄÅÁôªÂ±±Á≠âÈ´òÂº∑Â∫¶ÈÅãÂãï',
      mask: 'üòä ÁÑ°ÈúÄÈÖçÊà¥Âè£ÁΩ©',
      indoor: 'ü™ü ÂèØÈñãÁ™óÈÄöÈ¢®Ôºå‰∫´ÂèóÊñ∞ÈÆÆÁ©∫Ê∞£',
      color: '#00e400'
    };
  } else if (aqi <= 100) {
    return {
      general: 'Á©∫Ê∞£ÂìÅË≥™ÂèØÊé•ÂèóÔºå‰∏ÄËà¨‰∫∫Áæ§ÂèØÊ≠£Â∏∏Ê¥ªÂãï',
      sensitive: '‚ö†Ô∏è ÊïèÊÑüÊóèÁæ§Ë´ãÊ∏õÂ∞ëÈï∑ÊôÇÈñìÊà∂Â§ñÂäáÁÉàÈÅãÂãï',
      exercise: 'üö∂‚Äç‚ôÇÔ∏è ÈÅ©ÂêàÔºöÊï£Ê≠•„ÄÅÁëú‰ºΩ„ÄÅËºïÂ∫¶ÊÖ¢Ë∑ë',
      mask: 'üò∑ Âª∫Ë≠∞ÈÖçÊà¥‰∏ÄËà¨Âè£ÁΩ©',
      indoor: 'ü™ü ÂèØÈÅ©Â∫¶ÈñãÁ™óÔºå‰øùÊåÅÁ©∫Ê∞£ÊµÅÈÄö',
      color: '#ffff00'
    };
  } else if (aqi <= 150) {
    return {
      general: 'Â∞çÊïèÊÑüÊóèÁæ§‰∏çÂÅ•Â∫∑Ôºå‰∏ÄËà¨‰∫∫Áæ§Ê∏õÂ∞ëÊà∂Â§ñÊ¥ªÂãï',
      sensitive: 'üö® ÊïèÊÑüÊóèÁæ§ÊáâÈÅøÂÖçÊà∂Â§ñÊ¥ªÂãï',
      exercise: 'üè† Âª∫Ë≠∞ÂÆ§ÂÖßÈÅãÂãïÔºöÁëú‰ºΩ„ÄÅ‰º∏Â±ï„ÄÅÈáçË®ì',
      mask: 'üò∑ ÂøÖÈ†àÈÖçÊà¥N95ÊàñÈÜ´Áî®Âè£ÁΩ©',
      indoor: 'üö™ ÈóúÈñâÈñÄÁ™óÔºå‰ΩøÁî®Á©∫Ê∞£Ê∏ÖÊ∑®Ê©ü',
      color: '#ff7e00'
    };
  } else if (aqi <= 200) {
    return {
      general: 'ÊâÄÊúâ‰∫∫Áæ§ÈÉΩÊáâÊ∏õÂ∞ëÊà∂Â§ñÊ¥ªÂãï',
      sensitive: 'üö´ ÊïèÊÑüÊóèÁæ§Ë´ãÁïôÂú®ÂÆ§ÂÖß',
      exercise: 'üè† ÂÉÖÂª∫Ë≠∞ÂÆ§ÂÖßËºïÂ∫¶Ê¥ªÂãï',
      mask: 'üò∑ Â§ñÂá∫ÂøÖÈ†àÈÖçÊà¥N95Âè£ÁΩ©',
      indoor: 'üö™ Á∑äÈñâÈñÄÁ™óÔºåÊåÅÁ∫å‰ΩøÁî®Á©∫Ê∞£Ê∏ÖÊ∑®Ê©ü',
      color: '#ff0000'
    };
  } else if (aqi <= 300) {
    return {
      general: 'ÊâÄÊúâ‰∫∫Áæ§ÈÅøÂÖçÊà∂Â§ñÊ¥ªÂãï',
      sensitive: 'üè† ÊâÄÊúâ‰∫∫ÊáâÁïôÂú®ÂÆ§ÂÖß',
      exercise: 'üö´ ÈÅøÂÖç‰ªª‰ΩïÊà∂Â§ñÈÅãÂãï',
      mask: 'üò∑ Â§ñÂá∫ÂãôÂøÖÈÖçÊà¥N95ÊàñÊõ¥È´òÁ≠âÁ¥öÂè£ÁΩ©',
      indoor: 'üö™ Á∑äÈñâÈñÄÁ™óÔºå‰ΩøÁî®È´òÊïàÁ©∫Ê∞£Ê∏ÖÊ∑®Ê©ü',
      color: '#8f3f97'
    };
  } else {
    return {
      general: '‚ö†Ô∏è Á∑äÊÄ•ÁãÄÊ≥ÅÔºÅÊâÄÊúâ‰∫∫ÊáâÁïôÂú®ÂÆ§ÂÖß',
      sensitive: 'üö® Á´ãÂç≥Â∞ãÊ±ÇÂÆ§ÂÖßÈÅøÈõ£Â†¥ÊâÄ',
      exercise: 'üö´ Á¶ÅÊ≠¢ÊâÄÊúâÊà∂Â§ñÊ¥ªÂãï',
      mask: 'üò∑ Â§ñÂá∫ÂøÖÈ†àÈÖçÊà¥Â∞àÊ•≠Èò≤Ë≠∑Âè£ÁΩ©',
      indoor: 'üö™ ÂØÜÈñâÂÆ§ÂÖßÔºå‰ΩøÁî®È´òÊïàÁ©∫Ê∞£Ê∏ÖÊ∑®Ë®≠ÂÇô',
      color: '#7e0023'
    };
  }
}

// Ëß£ÊûêËá™ÁÑ∂Ë™ûË®ÄÊü•Ë©¢
function parseQuery(text) {
  const cleanText = text.toLowerCase().replace(/[Á©∫Ê∞£ÂìÅË≥™|Á©∫Ê∞£|Á©∫ÂìÅ|pm2.5|aqi|Êü•Ë©¢|ÊÄéÈ∫ºÊ®£|Â¶Ç‰Ωï]/g, '');
  
  // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë®ÇÈñ±Áõ∏ÈóúÊåá‰ª§
  if (text.includes('Ë®ÇÈñ±') || text.includes('subscribe')) {
    return parseSubscribeQuery(text);
  }
  
  // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂèñÊ∂àË®ÇÈñ±
  if (text.includes('ÂèñÊ∂àË®ÇÈñ±') || text.includes('unsubscribe')) {
    return { type: 'unsubscribe', content: text };
  }
  
  // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Êü•ÁúãË®ÇÈñ±
  if (text.includes('ÊàëÁöÑË®ÇÈñ±') || text.includes('Ë®ÇÈñ±Ê∏ÖÂñÆ')) {
    return { type: 'list_subscriptions' };
  }
  
  // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊØîËºÉÊü•Ë©¢
  if (text.includes('ÊØîËºÉ') || text.includes('vs') || text.includes('Â∞çÊØî')) {
    return parseCompareQuery(text);
  }
  
  // Ê™¢Êü•ÊòØÂê¶ÂåÖÂê´ÂüéÂ∏ÇÂêçÁ®±
  for (const [chinese, english] of Object.entries(cityMap)) {
    if (text.includes(chinese) || cleanText.includes(english)) {
      return { type: 'single', city: english };
    }
  }
  
  // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞ÁâπÂÆöÂüéÂ∏ÇÔºåËøîÂõûnull
  return null;
}

// Ëß£ÊûêË®ÇÈñ±Êü•Ë©¢
function parseSubscribeQuery(text) {
  for (const [chinese, english] of Object.entries(cityMap)) {
    if (text.includes(chinese)) {
      return { type: 'subscribe', city: english, cityName: chinese };
    }
  }
  return { type: 'subscribe', city: null };
}

// Ëß£ÊûêÊØîËºÉÊü•Ë©¢
function parseCompareQuery(text) {
  const cities = [];
  for (const [chinese, english] of Object.entries(cityMap)) {
    if (text.includes(chinese)) {
      cities.push({ chinese, english });
    }
  }
  
  if (cities.length >= 2) {
    return { type: 'compare', cities: cities.slice(0, 5) }; // ÊúÄÂ§öÊØîËºÉ5ÂÄãÂüéÂ∏Ç
  }
  
  return null;
}

// Áç≤ÂèñÁ©∫Ê∞£ÂìÅË≥™Êï∏Êìö
async function getAirQuality(city) {
  try {
    const url = `${WAQI_BASE_URL}/feed/${city}/?token=${WAQI_TOKEN}`;
    const response = await axios.get(url);
    
    if (response.data.status === 'ok') {
      return response.data.data;
    } else {
      throw new Error('ÁÑ°Ê≥ïÁç≤ÂèñÁ©∫Ê∞£ÂìÅË≥™Êï∏Êìö');
    }
  } catch (error) {
    console.error('Áç≤ÂèñÁ©∫Ê∞£ÂìÅË≥™Êï∏ÊìöÈåØË™§:', error);
    throw error;
  }
}

// Áç≤ÂèñÂ§öÂÄãÂüéÂ∏ÇÁöÑÁ©∫Ê∞£ÂìÅË≥™Êï∏Êìö
async function getMultipleCitiesAirQuality(cities) {
  try {
    const promises = cities.map(async (cityInfo) => {
      try {
        const url = `${WAQI_BASE_URL}/feed/${cityInfo.english}/?token=${WAQI_TOKEN}`;
        const response = await axios.get(url);
        if (response.data.status === 'ok') {
          return {
            ...response.data.data,
            chineseName: cityInfo.chinese
          };
        }
        return null;
      } catch (error) {
        console.error(`Áç≤Âèñ${cityInfo.chinese}Á©∫Ê∞£ÂìÅË≥™Â§±Êïó:`, error);
        return null;
      }
    });
    
    const results = await Promise.all(promises);
    return results.filter(result => result !== null);
  } catch (error) {
    console.error('Áç≤ÂèñÂ§öÂüéÂ∏ÇÁ©∫Ê∞£ÂìÅË≥™Êï∏ÊìöÈåØË™§:', error);
    throw error;
  }
}

// ÂâµÂª∫ÊØèÊó•Â†±ÂëäFlex Message
function createDailyReportFlexMessage(citiesData) {
  const bestCity = citiesData.reduce((best, current) => 
    current.aqi < best.aqi ? current : best
  );
  
  return {
    type: 'flex',
    altText: `ÊØèÊó•Á©∫Ê∞£ÂìÅË≥™Â†±Âëä - ÊúÄ‰Ω≥: ${bestCity.chineseName}`,
    contents: {
      type: 'bubble',
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: 'üåÖ ÊØèÊó•Á©∫Ê∞£ÂìÅË≥™Â†±Âëä',
            weight: 'bold',
            color: '#ffffff',
            size: 'lg'
          }
        ],
        paddingAll: '20px',
        backgroundColor: '#4CAF50',
        spacing: 'md',
        height: '60px'
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: citiesData.map(city => {
          const aqiInfo = getAQILevel(city.aqi);
          return {
            type: 'box',
            layout: 'horizontal',
            contents: [
              {
                type: 'text',
                text: city.chineseName,
                weight: 'bold',
                size: 'sm',
                color: '#333333'
              },
              {
                type: 'text',
                text: `AQI ${city.aqi}`,
                weight: 'bold',
                size: 'sm',
                color: aqiInfo.color,
                align: 'end'
              }
            ],
            margin: 'md'
          };
        })
      }
    }
  };
}

// ÂâµÂª∫Á∑äÊÄ•Ë≠¶Â†±Ë®äÊÅØ
function createEmergencyAlertMessage(airQualityData) {
  const aqiInfo = getAQILevel(airQualityData.aqi);
  
  return {
    type: 'text',
    text: `üö® Á©∫Ê∞£ÂìÅË≥™Ë≠¶Â†±ÔºÅ\n\n` +
          `üìç ${airQualityData.city.name}\n` +
          `üí® AQI: ${airQualityData.aqi} (${aqiInfo.level})\n\n` +
          `‚ö†Ô∏è Âª∫Ë≠∞Á´ãÂç≥Êé°ÂèñÈò≤Ë≠∑Êé™ÊñΩÔºö\n` +
          `‚Ä¢ ÈÅøÂÖçÊà∂Â§ñÊ¥ªÂãï\n` +
          `‚Ä¢ ÈÖçÊà¥N95Âè£ÁΩ©\n` +
          `‚Ä¢ ÈóúÈñâÈñÄÁ™ó\n` +
          `‚Ä¢ ‰ΩøÁî®Á©∫Ê∞£Ê∏ÖÊ∑®Ê©ü`
  };
}

// ÂâµÂª∫Flex Message
function createAirQualityFlexMessage(data) {
  const aqiInfo = getAQILevel(data.aqi);
  const healthAdvice = getHealthAdvice(data.aqi);
  const updateTime = new Date(data.time.iso).toLocaleString('zh-TW', {
    timeZone: 'Asia/Taipei',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });

  const flexMessage = {
    type: 'flex',
    altText: `${data.city.name} Á©∫Ê∞£ÂìÅË≥™ AQI: ${data.aqi}`,
    contents: {
      type: 'bubble',
      styles: {
        header: {
          backgroundColor: aqiInfo.color
        }
      },
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: `${aqiInfo.emoji} Á©∫Ê∞£ÂìÅË≥™Â†±Âëä`,
            weight: 'bold',
            color: '#ffffff',
            size: 'lg',
            align: 'center'
          }
        ]
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'box',
            layout: 'vertical',
            margin: 'lg',
            spacing: 'sm',
            contents: [
              {
                type: 'box',
                layout: 'baseline',
                spacing: 'sm',
                contents: [
                  {
                    type: 'text',
                    text: 'ÂüéÂ∏Ç',
                    color: '#aaaaaa',
                    size: 'sm',
                    flex: 2
                  },
                  {
                    type: 'text',
                    text: data.city.name,
                    wrap: true,
                    color: '#666666',
                    size: 'sm',
                    flex: 5
                  }
                ]
              },
              {
                type: 'box',
                layout: 'baseline',
                spacing: 'sm',
                contents: [
                  {
                    type: 'text',
                    text: 'AQI',
                    color: '#aaaaaa',
                    size: 'sm',
                    flex: 2
                  },
                  {
                    type: 'text',
                    text: data.aqi.toString(),
                    wrap: true,
                    color: aqiInfo.color,
                    size: 'xl',
                    weight: 'bold',
                    flex: 5
                  }
                ]
              },
              {
                type: 'box',
                layout: 'baseline',
                spacing: 'sm',
                contents: [
                  {
                    type: 'text',
                    text: 'Á≠âÁ¥ö',
                    color: '#aaaaaa',
                    size: 'sm',
                    flex: 2
                  },
                  {
                    type: 'text',
                    text: aqiInfo.level,
                    wrap: true,
                    color: '#666666',
                    size: 'sm',
                    flex: 5
                  }
                ]
              },
              {
                type: 'separator',
                margin: 'md'
              },
              {
                type: 'text',
                text: 'üè• ÂÅ•Â∫∑Âª∫Ë≠∞',
                weight: 'bold',
                size: 'md',
                margin: 'md',
                color: '#333333'
              },
              {
                type: 'text',
                text: healthAdvice.general,
                wrap: true,
                color: '#666666',
                size: 'sm',
                margin: 'sm'
              },
              {
                type: 'text',
                text: healthAdvice.sensitive,
                wrap: true,
                color: '#666666',
                size: 'sm',
                margin: 'xs'
              },
              {
                type: 'text',
                text: healthAdvice.exercise,
                wrap: true,
                color: '#666666',
                size: 'sm',
                margin: 'xs'
              },
              {
                type: 'text',
                text: healthAdvice.mask,
                wrap: true,
                color: '#666666',
                size: 'sm',
                margin: 'xs'
              },
              {
                type: 'separator',
                margin: 'md'
              },
              {
                type: 'text',
                text: 'üìä Ë©≥Á¥∞Êï∏Êìö',
                weight: 'bold',
                size: 'md',
                margin: 'md',
                color: '#333333'
              }
            ]
          }
        ]
      }
    }
  };

  // Ê∑ªÂä†Ë©≥Á¥∞Ê±°ÊüìÁâ©Êï∏Êìö
  if (data.iaqi) {
    const pollutants = [
      { key: 'pm25', name: 'PM2.5', unit: 'Œºg/m¬≥' },
      { key: 'pm10', name: 'PM10', unit: 'Œºg/m¬≥' },
      { key: 'o3', name: 'Ëá≠Ê∞ß', unit: 'ppb' },
      { key: 'no2', name: '‰∫åÊ∞ßÂåñÊ∞Æ', unit: 'ppb' },
      { key: 'so2', name: '‰∫åÊ∞ßÂåñÁ°´', unit: 'ppb' },
      { key: 'co', name: '‰∏ÄÊ∞ßÂåñÁ¢≥', unit: 'mg/m¬≥' }
    ];

    pollutants.forEach(pollutant => {
      if (data.iaqi[pollutant.key]) {
        flexMessage.contents.body.contents[0].contents.push({
          type: 'box',
          layout: 'baseline',
          spacing: 'sm',
          contents: [
            {
              type: 'text',
              text: pollutant.name,
              color: '#aaaaaa',
              size: 'sm',
              flex: 2
            },
            {
              type: 'text',
              text: `${data.iaqi[pollutant.key].v} ${pollutant.unit}`,
              wrap: true,
              color: '#666666',
              size: 'sm',
              flex: 5
            }
          ]
        });
      }
    });
  }

  // Ê∑ªÂä†Êõ¥Êñ∞ÊôÇÈñì
  flexMessage.contents.footer = {
    type: 'box',
    layout: 'vertical',
    spacing: 'sm',
    contents: [
      {
        type: 'separator'
      },
      {
        type: 'text',
        text: `Êõ¥Êñ∞ÊôÇÈñì: ${updateTime}`,
        color: '#aaaaaa',
        size: 'xs',
        align: 'center',
        margin: 'sm'
      }
    ]
  };

  return flexMessage;
}

// ÂâµÂª∫ÂüéÂ∏ÇÈÅ∏ÊìáÂø´ÈÄüÂõûË¶Ü
function createCityQuickReply() {
  const popularCities = ['Âè∞Âåó', 'Âè∞‰∏≠', 'Âè∞Âçó', 'È´òÈõÑ', 'Êñ∞Âåó', 'Ê°ÉÂúí'];
  
  return {
    type: 'text',
    text: 'Ë´ãÈÅ∏ÊìáË¶ÅÊü•Ë©¢ÁöÑÂüéÂ∏ÇÔºåÊàñÁõ¥Êé•Ëº∏ÂÖ•ÂüéÂ∏ÇÂêçÁ®±Ôºö\n\nüí° ÂäüËÉΩÊèêÁ§∫Ôºö\n‚Ä¢ Êü•Ë©¢Ôºö„ÄåÂè∞ÂåóÁ©∫Ê∞£ÂìÅË≥™„Äç\n‚Ä¢ ÊØîËºÉÔºö„ÄåÊØîËºÉÂè∞ÂåóÈ´òÈõÑ„Äç\n‚Ä¢ Ë®ÇÈñ±Ôºö„ÄåË®ÇÈñ±Âè∞Âåó„Äç\n‚Ä¢ ÂÆö‰ΩçÔºöÁõ¥Êé•ÂàÜ‰∫´‰ΩçÁΩÆ',
    quickReply: {
      items: [
        ...popularCities.map(city => ({
          type: 'action',
          action: {
            type: 'message',
            label: city,
            text: `Êü•Ë©¢${city}Á©∫Ê∞£ÂìÅË≥™`
          }
        })),
        {
          type: 'action',
          action: {
            type: 'message',
            label: 'ÊØîËºÉÂüéÂ∏Ç',
            text: 'ÊØîËºÉÂè∞ÂåóÂè∞‰∏≠È´òÈõÑ'
          }
        },
        {
          type: 'action',
          action: {
            type: 'message',
            label: 'ÊàëÁöÑË®ÇÈñ±',
            text: 'ÊàëÁöÑË®ÇÈñ±Ê∏ÖÂñÆ'
          }
        },
        {
          type: 'action',
          action: {
            type: 'location',
            label: 'ÂàÜ‰∫´‰ΩçÁΩÆ'
          }
        }
      ]
    }
  };
}

// ÂâµÂª∫Â§öÂüéÂ∏ÇÊØîËºÉFlex Message
function createCityComparisonFlexMessage(citiesData) {
  // ÊåâAQIÊéíÂ∫è
  const sortedCities = citiesData.sort((a, b) => a.aqi - b.aqi);
  
  // Ê±∫ÂÆöÊúÄ‰Ω≥ÂüéÂ∏ÇÁöÑÂª∫Ë≠∞
  const bestCity = sortedCities[0];
  const worstCity = sortedCities[sortedCities.length - 1];
  const bestAqiInfo = getAQILevel(bestCity.aqi);
  
  const flexMessage = {
    type: 'flex',
    altText: `Â§öÂüéÂ∏ÇÁ©∫Ê∞£ÂìÅË≥™ÊØîËºÉ - ÊúÄ‰Ω≥: ${bestCity.chineseName} AQI: ${bestCity.aqi}`,
    contents: {
      type: 'bubble',
      styles: {
        header: {
          backgroundColor: '#4CAF50'
        }
      },
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: 'üèÜ Â§öÂüéÂ∏ÇÁ©∫Ê∞£ÂìÅË≥™ÊØîËºÉ',
            weight: 'bold',
            color: '#ffffff',
            size: 'lg',
            align: 'center'
          }
        ]
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: 'üìä ÊéíÂêçÁµêÊûúÔºàÁî±‰Ω≥Ëá≥Â∑ÆÔºâ',
            weight: 'bold',
            size: 'md',
            margin: 'lg',
            color: '#333333'
          }
        ]
      }
    }
  };

  // Ê∑ªÂä†ÊéíÂêçÂúñÊ®ô
  const rankEmojis = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];

  // ÁÇ∫ÊØèÂÄãÂüéÂ∏ÇÊ∑ªÂä†ÊéíÂêçË≥áË®ä
  sortedCities.forEach((city, index) => {
    const aqiInfo = getAQILevel(city.aqi);
    const rankEmoji = rankEmojis[index] || `${index + 1}Ô∏è‚É£`;
    
    flexMessage.contents.body.contents.push({
      type: 'box',
      layout: 'horizontal',
      spacing: 'sm',
      margin: 'md',
      contents: [
        {
          type: 'text',
          text: rankEmoji,
          size: 'lg',
          flex: 1,
          align: 'center'
        },
        {
          type: 'box',
          layout: 'vertical',
          flex: 4,
          contents: [
            {
              type: 'text',
              text: city.chineseName,
              weight: 'bold',
              size: 'md',
              color: '#333333'
            },
            {
              type: 'text',
              text: `${city.city.name}`,
              size: 'xs',
              color: '#999999'
            }
          ]
        },
        {
          type: 'box',
          layout: 'vertical',
          flex: 3,
          contents: [
            {
              type: 'text',
              text: `AQI ${city.aqi}`,
              weight: 'bold',
              size: 'md',
              color: aqiInfo.color,
              align: 'end'
            },
            {
              type: 'text',
              text: aqiInfo.level,
              size: 'xs',
              color: '#666666',
              align: 'end'
            }
          ]
        }
      ]
    });
    
    // Ê∑ªÂä†ÂàÜÈöîÁ∑öÔºàÈô§‰∫ÜÊúÄÂæå‰∏ÄÂÄãÔºâ
    if (index < sortedCities.length - 1) {
      flexMessage.contents.body.contents.push({
        type: 'separator',
        margin: 'md'
      });
    }
  });

  // Ê∑ªÂä†ÊóÖË°åÂª∫Ë≠∞
  const recommendation = bestCity.aqi <= 100 ? 
    `‚úàÔ∏è Êé®Ëñ¶ÂâçÂæÄ ${bestCity.chineseName}ÔºÅÁ©∫Ê∞£ÂìÅË≥™${bestAqiInfo.level}` :
    `‚ö†Ô∏è ÊâÄÊúâÂüéÂ∏ÇÁ©∫Ê∞£ÂìÅË≥™ÈÉΩÈúÄÊ≥®ÊÑèÔºå${bestCity.chineseName} Áõ∏Â∞çÊúÄ‰Ω≥`;

  flexMessage.contents.body.contents.push(
    {
      type: 'separator',
      margin: 'lg'
    },
    {
      type: 'text',
      text: 'üéØ ÊóÖË°åÂª∫Ë≠∞',
      weight: 'bold',
      size: 'md',
      margin: 'lg',
      color: '#333333'
    },
    {
      type: 'text',
      text: recommendation,
      wrap: true,
      color: '#666666',
      size: 'sm',
      margin: 'sm'
    }
  );

  // Ê∑ªÂä†Êõ¥Êñ∞ÊôÇÈñì
  const updateTime = new Date().toLocaleString('zh-TW', {
    timeZone: 'Asia/Taipei',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });

  flexMessage.contents.footer = {
    type: 'box',
    layout: 'vertical',
    spacing: 'sm',
    contents: [
      {
        type: 'separator'
      },
      {
        type: 'text',
        text: `Êõ¥Êñ∞ÊôÇÈñì: ${updateTime}`,
        color: '#aaaaaa',
        size: 'xs',
        align: 'center',
        margin: 'sm'
      }
    ]
  };

  return flexMessage;
}

// ËôïÁêÜLINEË®äÊÅØ
async function handleEvent(event) {
  if (event.type !== 'message') {
    return Promise.resolve(null);
  }

  const userId = event.source.userId;

  // ËôïÁêÜ‰ΩçÁΩÆË®äÊÅØ
  if (event.message.type === 'location') {
    try {
      const { latitude, longitude } = event.message;
      locationCache.set(userId, { lat: latitude, lng: longitude, timestamp: Date.now() });
      
      const nearbyStations = await findNearbyStations(latitude, longitude);
      const flexMessage = createNearbyStationsFlexMessage(nearbyStations, latitude, longitude);
      
      return client.replyMessage(event.replyToken, flexMessage);
    } catch (error) {
      console.error('ËôïÁêÜ‰ΩçÁΩÆË®äÊÅØÈåØË™§:', error);
      const errorMessage = {
        type: 'text',
        text: 'üòµ Êü•Ë©¢ÈôÑËøëÁ©∫Ê∞£ÂìÅË≥™ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ'
      };
      return client.replyMessage(event.replyToken, errorMessage);
    }
  }

  // ËôïÁêÜÊñáÂ≠óË®äÊÅØ
  if (event.message.type !== 'text') {
    return Promise.resolve(null);
  }

  const userMessage = event.message.text;
  
  try {
    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂïèÂÄôË™ûÊàñÂπ´Âä©Êåá‰ª§
    if (userMessage.match(/^(‰Ω†Â•Ω|ÂìàÂõâ|hello|hi|Âπ´Âä©|help|‰ΩøÁî®Ë™™Êòé)/i)) {
      const helpMessage = {
        type: 'text',
        text: 'üåü Ê≠°Ëøé‰ΩøÁî®Êô∫ÊÖßÁ©∫Ê∞£ÂìÅË≥™Ê©üÂô®‰∫∫ÔºÅ\n\n' +
              'üìã Êü•Ë©¢ÂäüËÉΩÔºö\n' +
              '‚Ä¢ ÂñÆÂüéÂ∏ÇÔºö„ÄåÂè∞ÂåóÁ©∫Ê∞£ÂìÅË≥™„Äç\n' +
              '‚Ä¢ Â§öÂüéÂ∏ÇÊØîËºÉÔºö„ÄåÊØîËºÉÂè∞ÂåóÈ´òÈõÑÂè∞‰∏≠„Äç\n' +
              '‚Ä¢ ÈôÑËøëÊü•Ë©¢ÔºöÁõ¥Êé•ÂàÜ‰∫´‰ΩçÁΩÆ\n\n' +
              'üîî Ë®ÇÈñ±ÂäüËÉΩÔºö\n' +
              '‚Ä¢ Ë®ÇÈñ±ÂüéÂ∏ÇÔºö„ÄåË®ÇÈñ±Âè∞Âåó„Äç\n' +
              '‚Ä¢ Êü•ÁúãË®ÇÈñ±Ôºö„ÄåÊàëÁöÑË®ÇÈñ±„Äç\n' +
              '‚Ä¢ ÂèñÊ∂àË®ÇÈñ±Ôºö„ÄåÂèñÊ∂àË®ÇÈñ±Âè∞Âåó„Äç\n\n' +
              '‚ú® Êô∫ÊÖßÂäüËÉΩÔºö\n' +
              '‚Ä¢ üìä Â∞àÊ•≠ÂÅ•Â∫∑Âª∫Ë≠∞\n' +
              '‚Ä¢ üåÖ ÊØèÊó•ÂÆöÊôÇÂ†±Âëä\n' +
              '‚Ä¢ üö® Á©∫Ê∞£ÂìÅË≥™Ë≠¶Â†±\n' +
              '‚Ä¢ üìç GPSÂÆö‰ΩçÊü•Ë©¢\n\n' +
              'üåç ÊîØÊè¥Âè∞ÁÅ£ÂêÑÁ∏£Â∏ÇÂèäÂúãÈöõ‰∏ªË¶ÅÂüéÂ∏Ç'
      };
      
      return client.replyMessage(event.replyToken, [helpMessage, createCityQuickReply()]);
    }

    // Ëß£ÊûêÊü•Ë©¢ÁöÑÂÖßÂÆπ
    const queryResult = parseQuery(userMessage);
    
    // ËôïÁêÜË®ÇÈñ±ÂäüËÉΩ
    if (queryResult && queryResult.type === 'subscribe') {
      if (queryResult.city) {
        const success = addSubscription(userId, queryResult.city);
        const message = success ? 
          `‚úÖ Â∑≤ÊàêÂäüË®ÇÈñ± ${queryResult.cityName} ÁöÑÁ©∫Ê∞£ÂìÅË≥™ÊèêÈÜíÔºÅ\n\nüìÖ ÊØèÊó• 08:00 Êé®ÈÄÅÁ©∫Ê∞£ÂìÅË≥™Â†±Âëä\nüö® AQI>100 ÊôÇÁôºÈÄÅÁ∑äÊÄ•Ë≠¶Â†±\n\nËº∏ÂÖ•„ÄåÊàëÁöÑË®ÇÈñ±„ÄçÊü•ÁúãÊâÄÊúâË®ÇÈñ±\nËº∏ÂÖ•„ÄåÂèñÊ∂àË®ÇÈñ±${queryResult.cityName}„ÄçÂèØÂèñÊ∂à` :
          `üìã ÊÇ®Â∑≤Á∂ìË®ÇÈñ±‰∫Ü ${queryResult.cityName} ÁöÑÁ©∫Ê∞£ÂìÅË≥™ÊèêÈÜí`;
          
        return client.replyMessage(event.replyToken, { type: 'text', text: message });
      } else {
        const subscribeHelp = {
          type: 'text',
          text: 'üîî Ë®ÇÈñ±Á©∫Ê∞£ÂìÅË≥™ÊèêÈÜí\n\n‰ΩøÁî®ÊñπÂºèÔºö\n‚Ä¢ „ÄåË®ÇÈñ±Âè∞Âåó„Äç\n‚Ä¢ „ÄåË®ÇÈñ±È´òÈõÑ„Äç\n‚Ä¢ „ÄåË®ÇÈñ±Êñ∞Âä†Âù°„Äç\n\nË®ÇÈñ±ÂæåÊØèÊó•ÊúÉÊé®ÈÄÅÁ©∫Ê∞£ÂìÅË≥™Â†±ÂëäÔºå‰∏¶Âú®Á©∫Ê∞£ÂìÅË≥™ÊÉ°ÂåñÊôÇÁôºÈÄÅË≠¶Â†±„ÄÇ'
        };
        return client.replyMessage(event.replyToken, [subscribeHelp, createCityQuickReply()]);
      }
    }

    // ËôïÁêÜÂèñÊ∂àË®ÇÈñ±
    if (queryResult && queryResult.type === 'unsubscribe') {
      // Ê™¢Êü•ÊòØÂê¶ÊåáÂÆö‰∫ÜÂüéÂ∏Ç
      let cityToUnsubscribe = null;
      let cityNameToUnsubscribe = null;
      
      for (const [chinese, english] of Object.entries(cityMap)) {
        if (userMessage.includes(chinese)) {
          cityToUnsubscribe = english;
          cityNameToUnsubscribe = chinese;
          break;
        }
      }
      
      if (cityToUnsubscribe) {
        const success = removeSubscription(userId, cityToUnsubscribe);
        const message = success ?
          `‚úÖ Â∑≤ÂèñÊ∂àË®ÇÈñ± ${cityNameToUnsubscribe} ÁöÑÁ©∫Ê∞£ÂìÅË≥™ÊèêÈÜí` :
          `‚ùå ÊÇ®Ê≤íÊúâË®ÇÈñ± ${cityNameToUnsubscribe} ÁöÑÊèêÈÜí`;
        return client.replyMessage(event.replyToken, { type: 'text', text: message });
      } else {
        // ÂèñÊ∂àÊâÄÊúâË®ÇÈñ±
        const userSub = getUserSubscriptions(userId);
        if (userSub.cities.length > 0) {
          subscriptions.delete(userId);
          return client.replyMessage(event.replyToken, { 
            type: 'text', 
            text: '‚úÖ Â∑≤ÂèñÊ∂àÊâÄÊúâÁ©∫Ê∞£ÂìÅË≥™ÊèêÈÜíË®ÇÈñ±' 
          });
        } else {
          return client.replyMessage(event.replyToken, { 
            type: 'text', 
            text: '‚ùå ÊÇ®ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïË®ÇÈñ±' 
          });
        }
      }
    }

    // ËôïÁêÜÊü•ÁúãË®ÇÈñ±Ê∏ÖÂñÆ
    if (queryResult && queryResult.type === 'list_subscriptions') {
      const userSub = getUserSubscriptions(userId);
      if (userSub.cities.length === 0) {
        const noSubMessage = {
          type: 'text',
          text: 'üìã ÊÇ®ÁõÆÂâçÊ≤íÊúâË®ÇÈñ±‰ªª‰ΩïÂüéÂ∏Ç\n\nüí° ‰ΩøÁî®„ÄåË®ÇÈñ±Âè∞Âåó„ÄçÈñãÂßãË®ÇÈñ±Á©∫Ê∞£ÂìÅË≥™ÊèêÈÜí\n\nË®ÇÈñ±ÂæåÂèØ‰∫´ÂèóÔºö\n‚Ä¢ üåÖ ÊØèÊó•Á©∫Ê∞£ÂìÅË≥™Â†±Âëä\n‚Ä¢ üö® Á©∫Ê∞£ÂìÅË≥™ÊÉ°ÂåñË≠¶Â†±\n‚Ä¢ üìä ÂÄã‰∫∫ÂåñÂÅ•Â∫∑Âª∫Ë≠∞'
        };
        return client.replyMessage(event.replyToken, [noSubMessage, createCityQuickReply()]);
      }
      
      const cityNames = userSub.cities.map(city => {
        const chinese = Object.keys(cityMap).find(key => cityMap[key] === city);
        return chinese || city;
      });
      
      const subListMessage = {
        type: 'text',
        text: `üìã ÊÇ®ÁöÑË®ÇÈñ±Ê∏ÖÂñÆÔºö\n\n${cityNames.map((city, index) => `${index + 1}. ${city}`).join('\n')}\n\n‚öôÔ∏è Ë®≠ÂÆöÔºö\n‚Ä¢ üìÖ ÊØèÊó•Â†±ÂëäÔºöÂ∑≤ÈñãÂïü\n‚Ä¢ üö® Á∑äÊÄ•Ë≠¶Â†±ÔºöÂ∑≤ÈñãÂïü\n‚Ä¢ ‚ö†Ô∏è Ë≠¶Â†±ÈñæÂÄºÔºöAQI > 100\n\nüí° Ëº∏ÂÖ•„ÄåÂèñÊ∂àË®ÇÈñ±[ÂüéÂ∏ÇÂêç]„ÄçÂèØÂèñÊ∂àÁâπÂÆöÂüéÂ∏Ç`
      };
      return client.replyMessage(event.replyToken, subListMessage);
    }

    if (!queryResult) {
      const notFoundMessage = {
        type: 'text',
        text: 'ü§î Êä±Ê≠âÔºåÊàëÁÑ°Ê≥ïË≠òÂà•ÊÇ®Ë¶ÅÊü•Ë©¢ÁöÑÂÖßÂÆπ„ÄÇ\n\nË´ãÂòóË©¶Ôºö\n‚Ä¢ Êü•Ë©¢Ôºö„ÄåÂè∞ÂåóÁ©∫Ê∞£ÂìÅË≥™„Äç\n‚Ä¢ ÊØîËºÉÔºö„ÄåÊØîËºÉÂè∞ÂåóÈ´òÈõÑ„Äç\n‚Ä¢ Ë®ÇÈñ±Ôºö„ÄåË®ÇÈñ±Âè∞Âåó„Äç\n‚Ä¢ ÂÆö‰ΩçÔºöÂàÜ‰∫´ÊÇ®ÁöÑ‰ΩçÁΩÆ'
      };
      
      return client.replyMessage(event.replyToken, [notFoundMessage, createCityQuickReply()]);
    }

    // ËôïÁêÜÂ§öÂüéÂ∏ÇÊØîËºÉ
    if (queryResult.type === 'compare') {
      const citiesData = await getMultipleCitiesAirQuality(queryResult.cities);
      
      if (citiesData.length === 0) {
        const errorMessage = {
          type: 'text',
          text: 'üòµ Êä±Ê≠âÔºåÁÑ°Ê≥ïÁç≤ÂèñÈÄô‰∫õÂüéÂ∏ÇÁöÑÁ©∫Ê∞£ÂìÅË≥™Êï∏Êìö„ÄÇ\nË´ãÁ®çÂæåÂÜçË©¶ÔºåÊàñÂòóË©¶ÂÖ∂‰ªñÂüéÂ∏Ç„ÄÇ'
        };
        return client.replyMessage(event.replyToken, [errorMessage, createCityQuickReply()]);
      }
      
      if (citiesData.length === 1) {
        // Â¶ÇÊûúÂè™Êúâ‰∏ÄÂÄãÂüéÂ∏ÇÊúâÊï∏ÊìöÔºåËøîÂõûÂñÆÂüéÂ∏ÇÊü•Ë©¢ÁµêÊûú
        const flexMessage = createAirQualityFlexMessage(citiesData[0]);
        return client.replyMessage(event.replyToken, flexMessage);
      }
      
      // ÂâµÂª∫ÊØîËºÉÁµêÊûú
      const comparisonMessage = createCityComparisonFlexMessage(citiesData);
      return client.replyMessage(event.replyToken, comparisonMessage);
    }

    // ËôïÁêÜÂñÆÂüéÂ∏ÇÊü•Ë©¢
    if (queryResult.type === 'single') {
      const airQualityData = await getAirQuality(queryResult.city);
      const flexMessage = createAirQualityFlexMessage(airQualityData);
      
      return client.replyMessage(event.replyToken, flexMessage);
    }
    
  } catch (error) {
    console.error('ËôïÁêÜË®äÊÅØÈåØË™§:', error);
    
    const errorMessage = {
      type: 'text',
      text: 'üòµ Êä±Ê≠âÔºåÊü•Ë©¢Á©∫Ê∞£ÂìÅË≥™ÊôÇÁôºÁîüÈåØË™§„ÄÇ\nË´ãÁ®çÂæåÂÜçË©¶ÔºåÊàñÂòóË©¶Êü•Ë©¢ÂÖ∂‰ªñÂüéÂ∏Ç„ÄÇ'
    };
    
    return client.replyMessage(event.replyToken, [errorMessage, createCityQuickReply()]);
  }
}

// WebhookÁ´ØÈªû
app.post('/webhook', line.middleware(config), (req, res) => {
  Promise
    .all(req.body.events.map(handleEvent))
    .then((result) => res.json(result))
    .catch((err) => {
      console.error('WebhookËôïÁêÜÈåØË™§:', err);
      res.status(500).end();
    });
});

// ‰øÆÂæ©ÂæåÁöÑÈ¶ñÈ†ÅÁ´ØÈªû - Ëß£Ê±∫Êñá‰ª∂Ë∑ØÂæëÂïèÈ°å
app.get('/', (req, res) => {
  try {
    // Ê™¢Êü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
    const filePath = path.join(__dirname, 'public', 'index.html');
    if (fs.existsSync(filePath)) {
      res.sendFile(filePath);
    } else {
      // Â¶ÇÊûú public/index.html ‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû HTML ÂÖßÂÆπ
      res.send(`
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ÊÖßÁ©∫Ê∞£ÂìÅË≥™Ê©üÂô®‰∫∫ | LINE Bot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(-45deg, #667eea, #764ba2, #6b73ff, #9644ff); 
            background-size: 400% 400%;
            animation: gradient-shift 8s ease infinite;
            min-height: 100vh; 
            padding: 2rem 1rem;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .hero-section { 
            background: white; 
            padding: 3rem; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
            text-align: center; 
            margin-bottom: 3rem;
        }
        h1 { color: #333; margin-bottom: 1rem; font-size: 2.5rem; }
        p { color: #666; margin-bottom: 2rem; font-size: 1.2rem; line-height: 1.6; }
        .cta-button { 
            display: inline-block; 
            background: #00b900; 
            color: white; 
            padding: 15px 40px; 
            border-radius: 50px; 
            text-decoration: none; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            margin: 0.5rem;
        }
        .cta-button:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 30px rgba(0,185,0,0.3); 
        }
        .features { 
            margin-top: 2rem; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 1rem; 
        }
        .feature { 
            padding: 1rem; 
            background: #f8fafc; 
            border-radius: 10px; 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .feature i { 
            font-size: 2rem; 
            color: #00b900; 
            margin-bottom: 0.5rem; 
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #00e400;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ËÅäÂ§©Â±ïÁ§∫ÂçÄÂüü */
        .chat-demos {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            margin-bottom: 3rem;
        }
        
        .demo-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .demo-tab {
            padding: 0.8rem 1.5rem;
            background: #f8fafc;
            border: none;
            border-radius: 20px 20px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #666;
            font-size: 0.9rem;
        }
        
        .demo-tab.active {
            background: #00b900;
            color: white;
            transform: translateY(2px);
        }
        
        .chat-container {
            max-width: 400px;
            margin: 0 auto;
            background: #f8fafc;
            border-radius: 20px;
            padding: 1rem;
            min-height: 500px;
            position: relative;
            border: 3px solid #ddd;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #00b900;
            color: white;
            border-radius: 15px 15px 0 0;
            margin: -1rem -1rem 1rem -1rem;
        }
        
        .chat-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 1rem;
            background: white;
            padding: 5px;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .message {
            margin: 1rem 0;
            display: flex;
            align-items: flex-end;
            opacity: 0;
            animation: messageAppear 0.5s ease forwards;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.bot {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 0.8rem 1.2rem;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
        }
        
        .message.user .message-bubble {
            background: #00b900;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.bot .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e1e8ed;
            border-bottom-left-radius: 5px;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: #999;
            margin: 0 0.5rem;
        }
        
        .typing-indicator {
            display: none;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .typing-dots {
            display: inline-flex;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 18px;
            border-bottom-left-radius: 5px;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #999;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.5s infinite;
        }
        
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .demo-description {
            text-align: center;
            margin-bottom: 2rem;
            color: #666;
            font-size: 1.1rem;
        }
        
        .flex-message-preview {
            background: #f0f8ff;
            border: 2px dashed #00b900;
            border-radius: 15px;
            padding: 1rem;
            margin: 0.5rem 0;
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .hero-section, .chat-demos {
                padding: 2rem 1.5rem;
            }
            h1 { font-size: 2rem; }
            .demo-tabs {
                gap: 0.2rem;
            }
            .demo-tab {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            .chat-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Hero Section -->
        <div class="hero-section">
            <h1>üå¨Ô∏è Êô∫ÊÖßÁ©∫Ê∞£ÂìÅË≥™Ê©üÂô®‰∫∫</h1>
            <p><span class="status-indicator"></span>ÊúçÂãôÊ≠£Â∏∏ÈÅãË°å‰∏≠</p>
            <p>Âç≥ÊôÇÁõ£Ê∏¨Á©∫Ê∞£ÂìÅË≥™ÔºåÂÆàË≠∑ÊÇ®ÂíåÂÆ∂‰∫∫ÁöÑÂÅ•Â∫∑</p>
            
            <div style="margin: 2rem 0;">
                <a href="https://line.me/R/ti/p/@470kdmxx" class="cta-button" target="_blank">
                    <i class="fab fa-line"></i> Á´ãÂç≥Âä†ÂÖ•Â•ΩÂèã
                </a>
                <a href="/health" class="cta-button" style="background: #42a5f5;">
                    üîß ÊúçÂãôÁãÄÊÖã
                </a>
            </div>
            
            <div class="features">
                <div class="feature" onclick="showDemo('query')">
                    <i class="fas fa-search-location"></i>
                    <h4>Âç≥ÊôÇÊü•Ë©¢</h4>
                    <p>30+ ÊîØÊè¥ÂüéÂ∏Ç</p>
                </div>
                <div class="feature" onclick="showDemo('compare')">
                    <i class="fas fa-chart-line"></i>
                    <h4>Â§öÂüéÂ∏ÇÊØîËºÉ</h4>
                    <p>Êô∫ÊÖßÊéíÂ∫èÊé®Ëñ¶</p>
                </div>
                <div class="feature" onclick="showDemo('health')">
                    <i class="fas fa-user-md"></i>
                    <h4>ÂÅ•Â∫∑Âª∫Ë≠∞</h4>
                    <p>Â∞àÊ•≠Èò≤Ë≠∑ÊåáÂ∞é</p>
                </div>
                <div class="feature" onclick="showDemo('subscribe')">
                    <i class="fas fa-bell"></i>
                    <h4>Ë®ÇÈñ±ÊèêÈÜí</h4>
                    <p>ÊØèÊó•Â†±Âëä+Ë≠¶Â†±</p>
                </div>
                <div class="feature" onclick="showDemo('location')">
                    <i class="fas fa-map-marker-alt"></i>
                    <h4>GPSÂÆö‰Ωç</h4>
                    <p>ÈôÑËøëÁõ£Ê∏¨Á´ôÊü•Ë©¢</p>
                </div>
                <div class="feature" onclick="showDemo('ai')">
                    <i class="fas fa-robot"></i>
                    <h4>AIÊô∫ÊÖß</h4>
                    <p>Ëá™ÁÑ∂Ë™ûË®ÄÁêÜËß£</p>
                </div>
            </div>
        </div>
        
        <!-- Chat Demos Section -->
        <div class="chat-demos">
            <h2 style="text-align: center; margin-bottom: 2rem; color: #333;">üí¨ ÂäüËÉΩÂ±ïÁ§∫</h2>
            <p class="demo-description">ÈªûÊìä‰∏äÊñπÂäüËÉΩÂç°ÁâáÊàñ‰∏ãÊñπÊ®ôÁ±§ÔºåÊü•ÁúãÁúüÂØ¶Â∞çË©±ÁØÑ‰æã</p>
            
            <div class="demo-tabs">
                <button class="demo-tab active" onclick="showDemo('query')">üîç Âç≥ÊôÇÊü•Ë©¢</button>
                <button class="demo-tab" onclick="showDemo('compare')">üìä ÂüéÂ∏ÇÊØîËºÉ</button>
                <button class="demo-tab" onclick="showDemo('health')">üíä ÂÅ•Â∫∑Âª∫Ë≠∞</button>
                <button class="demo-tab" onclick="showDemo('subscribe')">üîî Ë®ÇÈñ±ÂäüËÉΩ</button>
                <button class="demo-tab" onclick="showDemo('location')">üìç GPSÂÆö‰Ωç</button>
                <button class="demo-tab" onclick="showDemo('ai')">ü§ñ AIÊô∫ÊÖß</button>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMwMGI5MDAiLz4KPHRleHQgeD0iMjAiIHk9IjI2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyMCI+8J+MrjwvdGV4dD4KPC9zdmc+" alt="Bot Avatar">
                    <div>
                        <div style="font-weight: bold;">Êô∫ÊÖßÁ©∫Ê∞£ÂìÅË≥™Ê©üÂô®‰∫∫</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Á∑ö‰∏ä</div>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be inserted here -->
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Links -->
        <div class="hero-section">
            <h3 style="color: #333; margin-bottom: 1rem;">üöÄ Âø´ÈÄüÊ∏¨Ë©¶</h3>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; font-size: 0.9rem;">
                <a href="/api/air-quality/taipei" style="color: #00b900; text-decoration: none;">üì° Âè∞ÂåóÁ©∫Ê∞£ÂìÅË≥™API</a>
                <a href="/api/air-quality/kaohsiung" style="color: #00b900; text-decoration: none;">üì° È´òÈõÑÁ©∫Ê∞£ÂìÅË≥™API</a>
                <a href="/debug" style="color: #666; text-decoration: none;">üîç Á≥ªÁµ±Ë®∫Êñ∑</a>
            </div>
            
            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.85rem; color: #999;">
                ¬© 2025 Êô∫ÊÖßÁ©∫Ê∞£ÂìÅË≥™Ê©üÂô®‰∫∫ | Áî®ÁßëÊäÄÂÆàË≠∑ÊØè‰∏ÄÊ¨°ÂëºÂê∏ üå±
            </div>
        </div>
    </div>

<script>
const demos = {
    query: {
        title: 'üîç Âç≥ÊôÇÁ©∫Ê∞£ÂìÅË≥™Êü•Ë©¢',
        description: 'Ëº∏ÂÖ•ÂüéÂ∏ÇÂêçÁ®±ÔºåÁ´ãÂç≥Áç≤ÂæóË©≥Á¥∞ÁöÑÁ©∫Ê∞£ÂìÅË≥™Â†±Âëä',
        messages: [
            { type: 'user', text: 'Âè∞ÂåóÁ©∫Ê∞£ÂìÅË≥™', time: '14:30' },
            { type: 'bot', text: 'Ê≠£Âú®Êü•Ë©¢Âè∞ÂåóÁöÑÁ©∫Ê∞£ÂìÅË≥™Êï∏Êìö...', time: '14:30', delay: 1000 },
            { type: 'bot', content: 'flex', title: 'Âè∞ÂåóÁ©∫Ê∞£ÂìÅË≥™Â†±Âëä', 
              preview: 'üå¨Ô∏è AQI: 65 (ÊôÆÈÄö)\\nüìç Âè∞ÂåóÂ∏Ç\\nüò∑ Âª∫Ë≠∞ÈÖçÊà¥‰∏ÄËà¨Âè£ÁΩ©\\nüèÉ‚Äç‚ôÇÔ∏è ÈÅ©ÂêàÊï£Ê≠•„ÄÅÁëú‰ºΩ', 
              time: '14:31', delay: 2500 }
        ]
    },
    compare: {
        title: 'üìä Â§öÂüéÂ∏ÇÁ©∫Ê∞£ÂìÅË≥™ÊØîËºÉ',
        description: '‰∏ÄÊ¨°ÊØîËºÉÂ§öÂÄãÂüéÂ∏ÇÔºåÊô∫ÊÖßÊéíÂ∫èÊé®Ëñ¶ÊúÄ‰Ω≥ÈÅ∏Êìá',
        messages: [
            { type: 'user', text: 'ÊØîËºÉÂè∞ÂåóÈ´òÈõÑÂè∞‰∏≠', time: '15:20' },
            { type: 'bot', text: 'Ê≠£Âú®ÊØîËºÉ‰∏âÂÄãÂüéÂ∏ÇÁöÑÁ©∫Ê∞£ÂìÅË≥™...', time: '15:20', delay: 1000 },
            { type: 'bot', content: 'flex', title: 'üèÜ Â§öÂüéÂ∏ÇÊØîËºÉÁµêÊûú', 
              preview: 'ü•á Âè∞‰∏≠ AQI: 45 (ËâØÂ•Ω)\\nü•à Âè∞Âåó AQI: 65 (ÊôÆÈÄö)\\nü•â È´òÈõÑ AQI: 85 (ÊôÆÈÄö)\\n\\n‚úàÔ∏è Êé®Ëñ¶ÂâçÂæÄÂè∞‰∏≠ÔºÅ', 
              time: '15:21', delay: 3000 }
        ]
    },
    health: {
        title: 'üíä Â∞àÊ•≠ÂÅ•Â∫∑Âª∫Ë≠∞',
        description: 'Ê†πÊìöÁ©∫Ê∞£ÂìÅË≥™Êèê‰æõÂÄã‰∫∫ÂåñÂÅ•Â∫∑Èò≤Ë≠∑ÊåáÂ∞é',
        messages: [
            { type: 'user', text: 'È´òÈõÑÁ©∫Ê∞£ÂìÅË≥™', time: '16:45' },
            { type: 'bot', content: 'flex', title: 'È´òÈõÑÁ©∫Ê∞£ÂìÅË≥™Â†±Âëä', 
              preview: 'üò∞ AQI: 120 (‰∏çÂÅ•Â∫∑)\\nüö® Âª∫Ë≠∞Ê∏õÂ∞ëÊà∂Â§ñÊ¥ªÂãï\\nüò∑ ÂøÖÈ†àÈÖçÊà¥N95Âè£ÁΩ©\\nüè† ÈóúÈñâÈñÄÁ™ó‰ΩøÁî®Á©∫Ê∞£Ê∏ÖÊ∑®Ê©ü', 
              time: '16:46', delay: 2000 },
            { type: 'user', text: 'ÂèØ‰ª•ÈÅãÂãïÂóéÔºü', time: '16:47' },
            { type: 'bot', text: 'ÁõÆÂâçÈ´òÈõÑAQIÁÇ∫120ÔºåÂª∫Ë≠∞Ôºö\\n\\nüè† ÂÉÖÂª∫Ë≠∞ÂÆ§ÂÖßËºïÂ∫¶Ê¥ªÂãï\\nüö´ ÈÅøÂÖçÊà∂Â§ñÈÅãÂãï\\nüí™ ÂèØÂú®ÂÆ§ÂÖßÂÅöÁëú‰ºΩ„ÄÅ‰º∏Â±ï\\n‚ö†Ô∏è ÊïèÊÑüÊóèÁæ§Ë´ãÁâπÂà•Ê≥®ÊÑè', time: '16:47', delay: 1500 }
        ]
    },
    subscribe: {
        title: 'üîî Ë®ÇÈñ±ÊèêÈÜíÊúçÂãô',
        description: 'ÊØèÊó•Êé®ÈÄÅÁ©∫Ê∞£ÂìÅË≥™Â†±ÂëäÔºåÊÉ°ÂåñÊôÇÁ´ãÂç≥Ë≠¶Â†±',
        messages: [
            { type: 'user', text: 'Ë®ÇÈñ±Âè∞Âåó', time: '09:15' },
            { type: 'bot', text: '‚úÖ Â∑≤ÊàêÂäüË®ÇÈñ±Âè∞ÂåóÁöÑÁ©∫Ê∞£ÂìÅË≥™ÊèêÈÜíÔºÅ\\n\\nüìÖ ÊØèÊó• 08:00 Êé®ÈÄÅÂ†±Âëä\\nüö® AQI>100 ÊôÇÁ∑äÊÄ•Ë≠¶Â†±\\n\\nËº∏ÂÖ•„ÄåÊàëÁöÑË®ÇÈñ±„ÄçÊü•ÁúãÊ∏ÖÂñÆ', time: '09:15', delay: 1000 },
            { type: 'user', text: 'ÊàëÁöÑË®ÇÈñ±', time: '09:16' },
            { type: 'bot', text: 'üìã ÊÇ®ÁöÑË®ÇÈñ±Ê∏ÖÂñÆÔºö\\n\\n1. Âè∞Âåó\\n\\n‚öôÔ∏è Ë®≠ÂÆöÔºö\\n‚Ä¢ üìÖ ÊØèÊó•Â†±ÂëäÔºöÂ∑≤ÈñãÂïü\\n‚Ä¢ üö® Á∑äÊÄ•Ë≠¶Â†±ÔºöÂ∑≤ÈñãÂïü\\n‚Ä¢ ‚ö†Ô∏è Ë≠¶Â†±ÈñæÂÄºÔºöAQI > 100', time: '09:16', delay: 1200 }
        ]
    },
    location: {
        title: 'üìç GPSÂÆö‰ΩçÊü•Ë©¢',
        description: 'ÂàÜ‰∫´‰ΩçÁΩÆÂç≥ÂèØÊü•Ë©¢ÈôÑËøëÁõ£Ê∏¨Á´ôÁöÑÁ©∫Ê∞£ÂìÅË≥™',
        messages: [
            { type: 'user', text: '[ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ]', time: '12:30', location: true },
            { type: 'bot', text: 'Ê≠£Âú®Êü•ÊâæÊÇ®ÈôÑËøëÁöÑÁ©∫Ê∞£ÂìÅË≥™Áõ£Ê∏¨Á´ô...', time: '12:30', delay: 1500 },
            { type: 'bot', content: 'flex', title: 'üìç ÈôÑËøëÁõ£Ê∏¨Á´ô', 
              preview: '1. Âè∞ÂåóËªäÁ´ô (0.8km)\\n   AQI: 62 (ÊôÆÈÄö)\\n\\n2. ‰∏≠Â±±Á´ô (1.2km)\\n   AQI: 58 (ÊôÆÈÄö)\\n\\n3. Ë•øÈñÄÁ´ô (1.5km)\\n   AQI: 65 (ÊôÆÈÄö)', 
              time: '12:31', delay: 3000 }
        ]
    },
    ai: {
        title: 'ü§ñ AIÊô∫ÊÖßÂ∞çË©±',
        description: 'Ëá™ÁÑ∂Ë™ûË®ÄÁêÜËß£ÔºåÊîØÊè¥Â§öÁ®ÆÈùàÊ¥ªÁöÑÊü•Ë©¢ÊñπÂºè',
        messages: [
            { type: 'user', text: '‰ªäÂ§©ÈÅ©ÂêàÂá∫ÈñÄÂóéÔºüÊàëÂú®Âè∞Âåó', time: '08:30' },
            { type: 'bot', text: 'ËÆìÊàëÊü•‰∏Ä‰∏ãÂè∞Âåó‰ªäÂ§©ÁöÑÁ©∫Ê∞£ÂìÅË≥™...', time: '08:30', delay: 1000 },
            { type: 'bot', text: 'Âè∞Âåó‰ªäÂ§©AQIÁÇ∫65ÔºàÊôÆÈÄöÁ≠âÁ¥öÔºâ\\n\\nüòä ÈÅ©ÂêàÂá∫ÈñÄÔºÅÂª∫Ë≠∞Ôºö\\n‚Ä¢ üö∂‚Äç‚ôÇÔ∏è ÈÅ©ÂêàÊï£Ê≠•„ÄÅËºïÂ∫¶ÈÅãÂãï\\n‚Ä¢ üò∑ Âª∫Ë≠∞ÈÖçÊà¥‰∏ÄËà¨Âè£ÁΩ©\\n‚Ä¢ ‚ö†Ô∏è ÊïèÊÑüÊóèÁæ§Ê≥®ÊÑèÈò≤Ë≠∑', time: '08:31', delay: 2500 },
            { type: 'user', text: 'Ë¨ùË¨ùÔºÅ', time: '08:32' },
            { type: 'bot', text: '‰∏çÂÆ¢Ê∞£ÔºÅüòä Èö®ÊôÇÁÇ∫ÊÇ®Áõ£Ê∏¨Á©∫Ê∞£ÂìÅË≥™„ÄÇ\\nÂ¶ÇÈúÄÂÖ∂‰ªñÂüéÂ∏ÇË≥áË®äÊàñÊÉ≥Ë®ÇÈñ±ÊèêÈÜíÔºåÈÉΩÂèØ‰ª•ÂëäË®¥ÊàëÂñîÔΩû', time: '08:32', delay: 800 }
        ]
    }
};

let currentDemo = 'query';
let messageIndex = 0;
let isPlaying = false;

function showDemo(demoKey) {
    if (isPlaying) return;
    
    currentDemo = demoKey;
    messageIndex = 0;
    
    // Update tab styles
    document.querySelectorAll('.demo-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event?.target?.classList.add('active') || 
    document.querySelector(\`[onclick="showDemo('\${demoKey}')"]\`).classList.add('active');
    
    // Clear messages
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    // Start playing messages
    playDemo();
}

function playDemo() {
    if (isPlaying) return;
    isPlaying = true;
    
    const demo = demos[currentDemo];
    const messagesContainer = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    
    function showNextMessage() {
        if (messageIndex >= demo.messages.length) {
            isPlaying = false;
            return;
        }
        
        const message = demo.messages[messageIndex];
        const delay = message.delay || 0;
        
        // Show typing indicator for bot messages
        if (message.type === 'bot' && delay > 500) {
            typingIndicator.style.display = 'block';
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                addMessage(message);
                messageIndex++;
                setTimeout(showNextMessage, 500);
            }, delay);
        } else {
            setTimeout(() => {
                addMessage(message);
                messageIndex++;
                setTimeout(showNextMessage, 500);
            }, delay);
        }
    }
    
    showNextMessage();
}

function addMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = \`message \${message.type}\`;
    
    let messageContent = '';
    
    if (message.content === 'flex') {
        messageContent = \`
            <div class="message-bubble">
                <div class="flex-message-preview">
                    <strong>\${message.title}</strong><br>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem;">
                        \${message.preview.replace(/\\\\n/g, '<br>')}
                    </div>
                </div>
            </div>
            <div class="message-time">\${message.time}</div>
        \`;
    } else if (message.location) {
        messageContent = \`
            <div class="message-bubble">
                üìç ‰ΩçÁΩÆË≥áË®ä
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.8rem;">
                    üó∫Ô∏è Âè∞ÂåóÂ∏Ç‰∏≠Ê≠£ÂçÄ<br>
                    üìå 25.0478¬∞N, 121.5319¬∞E
                </div>
            </div>
            <div class="message-time">\${message.time}</div>
        \`;
    } else {
        messageContent = \`
            <div class="message-bubble">\${message.text.replace(/\\\\n/g, '<br>')}</div>
            <div class="message-time">\${message.time}</div>
        \`;
    }
    
    messageDiv.innerHTML = messageContent;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Initialize with first demo
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => showDemo('query'), 1000);
});

// Auto-cycle demos every 15 seconds when not manually controlled
let autoCycleTimer;
function startAutoCycle() {
    const demoKeys = Object.keys(demos);
    let currentIndex = 0;
    
    autoCycleTimer = setInterval(() => {
        if (!isPlaying) {
            currentIndex = (currentIndex + 1) % demoKeys.length;
            showDemo(demoKeys[currentIndex]);
        }
    }, 15000);
}

// Start auto-cycle after initial load
setTimeout(startAutoCycle, 10000);

// Pause auto-cycle when user interacts
document.querySelectorAll('.demo-tab, .feature').forEach(element => {
    element.addEventListener('click', () => {
        clearInterval(autoCycleTimer);
        setTimeout(startAutoCycle, 30000); // Restart after 30 seconds
    });
});
</script>
</body>
</html>
      `);
    }
  } catch (error) {
    console.error('È¶ñÈ†ÅËºâÂÖ•ÈåØË™§:', error);
    res.status(500).send(`
      <h1>ÊúçÂãôËá®ÊôÇ‰∏çÂèØÁî®</h1>
      <p>Ë´ãÁ®çÂæåÂÜçË©¶ÔºåÊàñËÅØÁπ´ÊäÄË°ìÊîØÊè¥</p>
      <p>ÈåØË™§: ${error.message}</p>
    `);
  }
});

// ÂÅ•Â∫∑Ê™¢Êü•Á´ØÈªû - Â¢ûÂº∑Ë®∫Êñ∑ÂäüËÉΩ
app.get('/health', (req, res) => {
  const publicExists = fs.existsSync(path.join(__dirname, 'public'));
  const indexExists = fs.existsSync(path.join(__dirname, 'public', 'index.html'));
  
  res.json({ 
    status: 'OK', 
    message: 'LINEÁ©∫Ê∞£ÂìÅË≥™Ê©üÂô®‰∫∫Ê≠£Â∏∏ÈÅãË°å‰∏≠ÔºÅ',
    timestamp: new Date().toISOString(),
    uptime: Math.floor(process.uptime()),
    environment: {
      node_version: process.version,
      platform: process.platform,
      memory_usage: process.memoryUsage(),
      public_folder_exists: publicExists,
      index_html_exists: indexExists,
      line_token_configured: !!process.env.LINE_CHANNEL_ACCESS_TOKEN,
      line_secret_configured: !!process.env.LINE_CHANNEL_SECRET,
      working_directory: __dirname
    },
    features: [
      'Âç≥ÊôÇÁ©∫Ê∞£ÂìÅË≥™Êü•Ë©¢',
      'Â§öÂüéÂ∏ÇÊØîËºÉ',
      'Êô∫ÊÖßÂÅ•Â∫∑Âª∫Ë≠∞',
      'Ë®ÇÈñ±ÊèêÈÜíÁ≥ªÁµ±',
      'GPSÂÆö‰ΩçÊü•Ë©¢'
    ]
  });
});

// APIÁ´ØÈªû - Áç≤ÂèñÂüéÂ∏ÇÁ©∫Ê∞£ÂìÅË≥™
app.get('/api/air-quality/:city', async (req, res) => {
  try {
    const city = req.params.city;
    console.log(`APIË´ãÊ±Ç - ÂüéÂ∏Ç: ${city}`);
    const airQualityData = await getAirQuality(city);
    res.json(airQualityData);
  } catch (error) {
    console.error('APIÈåØË™§:', error);
    res.status(500).json({ 
      error: 'ÁÑ°Ê≥ïÁç≤ÂèñÁ©∫Ê∞£ÂìÅË≥™Êï∏Êìö',
      details: error.message,
      city: req.params.city,
      timestamp: new Date().toISOString()
    });
  }
});

// Ë™øË©¶Á´ØÈªû - Ê™¢Êü•ÊúçÂãôÁãÄÊÖã
app.get('/debug', (req, res) => {
  try {
    res.json({
      server_status: 'running',
      timestamp: new Date().toISOString(),
      node_version: process.version,
      platform: process.platform,
      uptime: Math.floor(process.uptime()),
      memory_usage: process.memoryUsage(),
      environment_variables: {
        PORT: process.env.PORT,
        NODE_ENV: process.env.NODE_ENV,
        line_token_length: process.env.LINE_CHANNEL_ACCESS_TOKEN?.length || 0,
        line_secret_length: process.env.LINE_CHANNEL_SECRET?.length || 0
      },
      file_system: {
        current_directory: __dirname,
        public_exists: fs.existsSync(path.join(__dirname, 'public')),
        index_exists: fs.existsSync(path.join(__dirname, 'public', 'index.html')),
        package_exists: fs.existsSync(path.join(__dirname, 'package.json'))
      },
      routes: [
        'GET /',
        'GET /health', 
        'GET /debug',
        'GET /api/air-quality/:city',
        'POST /webhook'
      ],
      subscriptions_count: subscriptions.size,
      location_cache_count: locationCache.size
    });
  } catch (error) {
    res.status(500).json({
      error: 'Debug endpoint error',
      message: error.message
    });
  }
});

// ÈåØË™§ËôïÁêÜ‰∏≠Èñì‰ª∂
app.use((err, req, res, next) => {
  console.error('‰º∫ÊúçÂô®ÈåØË™§:', err);
  res.status(500).json({
    error: 'Internal Server Error',
    message: err.message,
    timestamp: new Date().toISOString()
  });
});

// 404 ËôïÁêÜ
app.use((req, res) => {
  res.status(404).json({
    error: 'Not Found',
    path: req.path,
    method: req.method,
    message: 'Ë´ãÊ±ÇÁöÑË∑ØÁî±‰∏çÂ≠òÂú®',
    available_routes: ['/', '/health', '/debug', '/api/air-quality/:city'],
    timestamp: new Date().toISOString()
  });
});

// ÂïüÂãïÊúçÂãôÂô®
const port = process.env.PORT || 3000;
app.listen(port, '0.0.0.0', () => {
  console.log(`LINEÊô∫ÊÖßÁ©∫Ê∞£ÂìÅË≥™Ê©üÂô®‰∫∫Âú®Á´ØÂè£ ${port} ‰∏äÈÅãË°å`);
  console.log('ÂäüËÉΩÂàóË°®Ôºö');
  console.log('‚úÖ Âç≥ÊôÇÁ©∫Ê∞£ÂìÅË≥™Êü•Ë©¢');
  console.log('‚úÖ Â§öÂüéÂ∏ÇÊØîËºÉÂäüËÉΩ');
  console.log('‚úÖ Êô∫ÊÖßÂÅ•Â∫∑Âª∫Ë≠∞Á≥ªÁµ±');
  console.log('‚úÖ Ë®ÇÈñ±ÊèêÈÜíÁ≥ªÁµ±');
  console.log('‚úÖ GPSÂÆö‰ΩçÊü•Ë©¢');
  console.log('‚úÖ Á≤æÁæé‰ªãÁ¥πÁ∂≤È†Å');
  console.log(`üåê ÊúçÂãôÁ∂≤ÂùÄ: http://0.0.0.0:${port}`);
  
  // Ê™¢Êü•Áí∞Â¢ÉËÆäÊï∏
  if (!process.env.LINE_CHANNEL_ACCESS_TOKEN || !process.env.LINE_CHANNEL_SECRET) {
    console.warn('‚ö†Ô∏è Ë≠¶ÂëäÔºöLINE Bot Áí∞Â¢ÉËÆäÊï∏Êú™ÂÆåÊï¥Ë®≠ÂÆö');
    console.warn('Ë´ãÂú® Render Dashboard Ë®≠ÂÆö‰ª•‰∏ãÁí∞Â¢ÉËÆäÊï∏Ôºö');
    console.warn('- LINE_CHANNEL_ACCESS_TOKEN');
    console.warn('- LINE_CHANNEL_SECRET');
  } else {
    console.log('‚úÖ LINE Bot Áí∞Â¢ÉËÆäÊï∏Ë®≠ÂÆöÂÆåÊàê');
  }
  
  // Ê™¢Êü•Êñá‰ª∂Á≥ªÁµ±
  console.log('üìÅ Êñá‰ª∂Á≥ªÁµ±Ê™¢Êü•Ôºö');
  console.log(`- Â∑•‰ΩúÁõÆÈåÑ: ${__dirname}`);
  console.log(`- public Ë≥áÊñôÂ§æÂ≠òÂú®: ${fs.existsSync(path.join(__dirname, 'public'))}`);
  console.log(`- index.html Â≠òÂú®: ${fs.existsSync(path.join(__dirname, 'public', 'index.html'))}`);
});